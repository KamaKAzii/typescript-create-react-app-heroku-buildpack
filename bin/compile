#!/bin/bash

BUILD_DIR=$1

herokuEcho () { 
  echo "-----> $1"
}

herokuEcho "============================================"
herokuEcho "============================================"
herokuEcho "Lego Create React App + Typescript stack! ðŸš€"
herokuEcho "============================================"
herokuEcho "============================================"

# ====================================
# Let's get NodeJS goin'! ðŸ¢
# ====================================

herokuEcho "About to get NodeJS ðŸ¢"

relativeNodePackageDir="bin/node"
nodePathWithinPackage="bin"
nodeDownloadDir="$BUILD_DIR/$relativeNodePackageDir"
absoluteNodePath="$nodeDownloadDir/$nodePathWithinPackage"

mkdir -p $nodeDownloadDir
curl -s https://nodejs.org/dist/v12.18.0/node-v12.18.0-linux-x64.tar.xz | tar --strip-components=1 -xJf - -C $nodeDownloadDir

herokuEcho "Successfully fetched NodeJS ðŸ¢ ðŸŒˆ"

PATH="$absoluteNodePath:$PATH"
herokuEcho "Added node to PATH ðŸ›£ ðŸ¢ ðŸŒˆ"
herokuEcho "Checking nodejs/npm/npx works from PATH ðŸ›£..."
herokuEcho "NodeJS version: $(node -v)"
herokuEcho "NPM version: $(npm -v)"
herokuEcho "NPX version: $(npx -v)"
herokuEcho "Yay! Good work Buildpack! Go you! â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸"

# ====================================
# Time to build! ðŸ‘·ðŸ¿â€â™€ï¸ ðŸ‘·ðŸ»â€â™‚ï¸ ðŸ›  ðŸ¡ ðŸ’ƒðŸ¿
# ====================================

herokuEcho "Running npm build script... ðŸƒðŸ»â€â™‚ï¸"
cd bar
npm run build 2>&1

# ====================================
# Set ðŸ›£ in the slug ðŸŒ
# ====================================

herokuEcho "Time to add to the ðŸŒ's path..."
mkdir -p $BUILD_DIR/.profile.d
scripts=$BUILD_DIR/.profile.d/cra-ts-buildpack-slug-scripts.sh
touch $scripts
echo "export PATH=\"\$HOME/$relativeNodePackageDir/$nodePathWithinPackage:\$PATH\"" > $scripts