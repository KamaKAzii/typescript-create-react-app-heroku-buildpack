#!/bin/bash

BUILD_DIR=$1
CACHE_DIR=$2

herokuEcho () { 
  echo "-----> $1"
}

herokuEcho "============================================"
herokuEcho "============================================"
herokuEcho "Lego Create React App + Typescript stack! 🚀"
herokuEcho "============================================"
herokuEcho "============================================"

# ====================================
# Let's get NodeJS and Yarn goin'! 🍢
# ====================================

herokuEcho "About to get NodeJS 🍢"

relativeNodePackageDir="bin/node"
nodeDownloadDir="$BUILD_DIR/$relativeNodePackageDir"
absoluteNodePath="$nodeDownloadDir/bin"
mkdir -p $nodeDownloadDir
curl -s https://nodejs.org/dist/v12.18.0/node-v12.18.0-linux-x64.tar.xz | tar --strip-components=1 -xJf - -C $nodeDownloadDir

herokuEcho "Successfully fetched NodeJS 🍢 🌈"
PATH="$absoluteNodePath:$PATH"
herokuEcho "Added node to PATH 🛣 🍢 🌈"
herokuEcho "Checking nodejs/npm/npx works from PATH 🛣..."
herokuEcho "NodeJS version: $(node -v)"
herokuEcho "NPM version: $(npm -v)"

touch ~/.bashrc
curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version 1.22.4
source ~/.bashrc

herokuEcho "I think we just installed yarn...: $(yarn -v) 📦"
herokuEcho "which yarn: $(which yarn)"

herokuEcho "Yay! Good work Buildpack! Go you! ⭐️⭐️⭐️⭐️⭐️"

# ====================================
# Time to build! 👷🏿‍♀️ 👷🏻‍♂️ 🛠 🏡 💃🏿 🍻
# ====================================

cd "$BUILD_DIR/bar"
herokuEcho "Installing node_module deps... 🏃🏻‍♂️"
npm install 2>&1
herokuEcho "Okay that's done! 🌈 📚"
herokuEcho "Now I'll run the build... 🏃🏻‍♂️"
npm run build 2>&1

# ====================================
# Update dat node_modules cache! 🎒
# ====================================
herokuEcho "Checking to see if the node_modules cache needs to be updated... 🎒 👀"


# ====================================
# Set 🛣 in the slug 🐌
# ====================================

herokuEcho "Time to add to the 🐌's path..."
mkdir -p $BUILD_DIR/.profile.d
scripts=$BUILD_DIR/.profile.d/cra-ts-buildpack-slug-scripts.sh
touch $scripts
echo "export PATH=\"\$HOME/$relativeNodePackageDir/bin:\$PATH\"" > $scripts