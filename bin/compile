#!/bin/bash

BUILD_DIR=$1
CACHE_DIR=$2

herokuEcho () { 
  echo "-----> $1"
}

herokuEcho "============================================================="
herokuEcho "============================================================="
herokuEcho "Lego Create React App + Typescript stack! ðŸš€"
herokuEcho "============================================================="
herokuEcho "============================================================="

# =====================================================
# Let's get NodeJS goin'! ðŸ¢
# =====================================================

herokuEcho "About to get NodeJS ðŸ¢"

relativeNodePackageDir="bin/node"
nodeDownloadDir="$BUILD_DIR/$relativeNodePackageDir"
absoluteNodePath="$nodeDownloadDir/bin"
mkdir -p $nodeDownloadDir
curl -s https://nodejs.org/dist/v12.18.0/node-v12.18.0-linux-x64.tar.xz | tar --strip-components=1 -xJf - -C $nodeDownloadDir

herokuEcho "Successfully fetched NodeJS ðŸ¢ ðŸŒˆ"
PATH="$absoluteNodePath:$PATH"
herokuEcho "Added node to PATH ðŸ›£ ðŸ¢ ðŸŒˆ"
herokuEcho "Checking nodejs/npm/npx works from PATH ðŸ›£..."
herokuEcho "NodeJS version: $(node -v)"
herokuEcho "NPM version: $(npm -v)"

# =====================================================
# Let's get Yarn goin'! ðŸ“¦ 
# =====================================================

touch ~/.bashrc
curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version 1.22.4
source ~/.bashrc
herokuEcho "I think we just instal4led yarn...: $(yarn -v) ðŸ“¦"
herokuEcho "Yay! Good work Buildpack! Go you! â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸"


# =====================================================
# Smash the node_modules cache (mebbe)! ðŸŽ’
# =====================================================

needsToInstallNodeModules=0;
herokuEcho "Checking to see if the node_modules cache are there to be updated... ðŸŽ’ ðŸ‘€"
if [ -d "$CACHE_DIR/node_modules" ]
then
  herokuEcho "Found em! ðŸ•µðŸ»â€â™‚ï¸ Node modules be chillin in 'ere!"
  mkdir -p "$BUILD_DIR/bar/node_modules"
  herokuEcho "LS FOR FUN?"
  herokuEcho "LS FOR FUN?"
  herokuEcho "LS FOR FUN?"
  ls $CACHE_DIR/node_modules/node_modules
  herokuEcho "WAS THE LS RIGHT??"
  herokuEcho "WAS THE LS RIGHT??"
  herokuEcho "WAS THE LS RIGHT??"
  herokuEcho "Gona try nm/nm lol"

  cp -r "$CACHE_DIR/node_modules/node_modules" "$BUILD_DIR/bar/node_modules"

  herokuEcho "Copied them into /bar's node moddies! â© â© â©"
else
  needsToInstallNodeModules=1;
  herokuEcho "Sorry, no cached node modules ðŸ™…ðŸ¼â€â™€ Gotta fetch em."
fi

cd "$BUILD_DIR/bar"
if [ $needsToInstallNodeModules -eq 1 ]
then
  herokuEcho "Installing node_module deps... ðŸƒðŸ»â€â™‚ï¸"
  yarn install 2>&1
  herokuEcho "Okay that's done! ðŸŒˆ ðŸ“š"
  herokuEcho "Copying the new moddies into the cache dir! ðŸŽ’"
  herokuEcho "LISTING $BUILD_DIR/bar/node_modules"
  ls $BUILD_DIR/bar/node_modules
  herokuEcho "WAS THAT RIGHT? $BUILD_DIR/bar/node_modules"
  mkdir -p "$CACHE_DIR/node_modules"
  cp -r "$BUILD_DIR/bar/node_modules" "$CACHE_DIR/node_modules"
  herokuEcho "Copied them to cache for next time! ðŸ“„ â© â© â© ðŸŽ’"
fi

# =====================================================
# Time to build! ðŸ‘·ðŸ¿â€â™€ï¸ ðŸ‘·ðŸ»â€â™‚ï¸ ðŸ›  ðŸ¡ ðŸ’ƒðŸ¿ ðŸ»
# =====================================================

herokuEcho "Now I'll run the build... ðŸƒðŸ»â€â™‚ï¸"
yarn run build 2>&1

# =====================================================
# Set ðŸ›£ in the slug ðŸŒ
# =====================================================

herokuEcho "Time to add to the ðŸŒ's path..."
mkdir -p $BUILD_DIR/.profile.d
scripts=$BUILD_DIR/.profile.d/cra-ts-buildpack-slug-scripts.sh
touch $scripts
echo "export PATH=\"\$HOME/$relativeNodePackageDir/bin:\$PATH\"" > $scripts